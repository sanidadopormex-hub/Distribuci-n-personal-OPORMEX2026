<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Distribución del personal OPORMEX</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    header { padding: 12px 16px; border-bottom: 1px solid #e5e5e5; display:flex; align-items:center; gap:10px; flex-wrap: wrap;}
    #map { width: 100%; height: 680px; }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f3f4f6;
      font-size: 12px;
    }

    .controls {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 999;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 1px 10px rgba(0,0,0,0.08);
      min-width: 260px;
      font-size: 13px;
    }

    .controls h4 { margin: 0 0 8px 0; font-size: 14px; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:10px; margin: 6px 0; }
    .row label { display:flex; align-items:center; gap:8px; cursor:pointer; }
    .row select, .row button { width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 8px; background:#fff; }
    .muted { color: #6b7280; font-size: 12px; }

    .legend {
      background: #fff;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      line-height: 1.4;
      font-size: 13px;
    }
    .dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
      border: 1px solid #3333;
    }
  </style>
</head>

<body>
  <header>
    <strong>Mapa de distribución del personal OPORMEX</strong>
    <span class="pill">Agrupado por OISA</span>
    <span class="pill" id="visibleCount">—</span>
  </header>

  <div id="map"></div>

  <!-- Panel de filtros -->
  <div class="controls" id="controls">
    <h4>Filtros</h4>

    <div class="row">
      <label><input type="checkbox" id="fAeropuerto" checked> Aeropuerto</label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="fPuerto" checked> Puerto</label>
    </div>
    <div class="row">
      <label><input type="checkbox" id="fFrontera" checked> Frontera</label>
    </div>

    <div class="row" style="margin-top:8px;">
      <div style="width:100%;">
        <div class="muted" style="margin-bottom:4px;">Estado</div>
        <select id="estadoSelect">
          <option value="__ALL__">Todos</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <button id="btnReset">Restablecer filtros</button>
    </div>

    <div class="muted" style="margin-top:6px;">
      Nota: los filtros aplican por OISA (no por persona).
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ==========================
    // 1) COLORES CONFIGURABLES
    // ==========================
    // Cambia estos hex para tus colores deseados.
    const COLORS = {
      Aeropuerto: "#91CBF3", // azul
      Puerto:     "#B1F68E", // verde
      Frontera:   "#F9BD8B", // rojo
      Default:    "#6b7280"  // gris
    };

    function colorPorTipo(tipo) {
      return COLORS[tipo] || COLORS.Default;
    }

    // ==========================
    // 2) MAPA BASE
    // ==========================
    const map = L.map("map").setView([23.6345, -102.5528], 5);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ==========================
    // 3) CATÁLOGO OISAs
    // ==========================
    const oisas = {
      "AICM": { estado: "CDMX", tipo: "Aeropuerto", lat: 19.43510, lng: -99.07130 },
      "AIFA": { estado: "Estado de México", tipo: "Aeropuerto", lat: 19.7418265, lng: -99.0132425 },
      "Cancún": { estado: "Quintana Roo", tipo: "Aeropuerto", lat: 21.0353, lng: -86.8728 },
      "Cd. Hidalgo": { estado: "Chiapas", tipo: "Frontera", lat: 14.6796279, lng: -92.1525959 },
      "Guadalajara": { estado: "Jalisco", tipo: "Aeropuerto", lat: 20.521836, lng: -103.311144 },
      "Manzanillo": { estado: "Colima", tipo: "Puerto", lat: 19.067583, lng: -104.291383 },
      "Mérida": { estado: "Yucatán", tipo: "Aeropuerto", lat: 20.937022, lng: -89.657694 },
      "Monterrey": { estado: "Nuevo León", tipo: "Aeropuerto", lat: 25.774851, lng: -100.113861 },
      "Nuevo Laredo": { estado: "Tamaulipas", tipo: "Frontera", lat: 27.47629, lng: -99.51639 },
      "Puerto Vallarta": { estado: "Jalisco", tipo: "Aeropuerto", lat: 20.68, lng: -105.25 },
      "Tijuana": { estado: "Baja California", tipo: "Frontera", lat: 32.5027, lng: -117.00371 },
      "Veracruz": { estado: "Veracruz", tipo: "Puerto", lat: 19.2, lng: -96.1333333 }
    };

    // ==========================
    // 4) PERSONAL (tabla)
    // ==========================
    const personal = [
      { nombre: "Samuel Marquez Bautista", oisa: "AICM" },
      { nombre: "Alan Ernesto Orozco Guevara", oisa: "AICM" },
      { nombre: "Rominna Alexandra Díaz Olvera", oisa: "AIFA" },
      { nombre: "Leonardo Mundo Estrada", oisa: "Cancún" },
      { nombre: "Venancio Villalobos Aguilar", oisa: "Cd. Hidalgo" },
      { nombre: "Ana Karen Flores Duarte", oisa: "Guadalajara" },

      { nombre: "Mariana Alcalá Carrillo", oisa: "Manzanillo" },
      { nombre: "Marjurith Jodany Quiñonez González", oisa: "Manzanillo" },
      { nombre: "Laura Ruiz Martínez", oisa: "Manzanillo" },
      { nombre: "Julio César Flores Sánchez", oisa: "Manzanillo" },
      { nombre: "Mariana Romero Hernández", oisa: "Manzanillo" },
      { nombre: "Jaquelin Cruz Solis", oisa: "Manzanillo" },
      { nombre: "Diana Yessica Montero Delgadillo", oisa: "Manzanillo" },
      { nombre: "Melvin Jonatan Michel Ortíz", oisa: "Manzanillo" },
      { nombre: "Immer Hernández De la O", oisa: "Manzanillo" },
      { nombre: "Montserrat Soledad Rodríguez Saavedra", oisa: "Manzanillo" },
      { nombre: "Sebastián Benjamín Gallardo Castro", oisa: "Manzanillo" },
      { nombre: "Jesús Petronilo García González", oisa: "Manzanillo" },
      { nombre: "Carlos Andrés Granados Ventura", oisa: "Manzanillo" },
      { nombre: "Brenda Karina Valle Rodríguez", oisa: "Manzanillo" },
      { nombre: "Miguel Ángel Chávez González", oisa: "Manzanillo" },
      { nombre: "Liliana Carolina Moreno Rodríguez", oisa: "Manzanillo" },
      { nombre: "Grimaldo Arturo Aguilar Ríos", oisa: "Manzanillo" },
      { nombre: "Ingrid Virginia Castillo Zacarías", oisa: "Manzanillo" },
      { nombre: "Ivanna Jocelyn Martínez Reyes", oisa: "Manzanillo" },
      { nombre: "Mayra Rodríguez Olmos", oisa: "Manzanillo" },
      { nombre: "Arianna Melisa Gutiérrez Gutiérrez", oisa: "Manzanillo" },
      { nombre: "Luis Enrique García Merino", oisa: "Manzanillo" },

      { nombre: "Adrián Izabal Ceja", oisa: "Mérida" },
      { nombre: "Mario Alberto Velasco Ramírez", oisa: "Monterrey" },
      { nombre: "Albacihuatzin Portilla Naranjo", oisa: "Nuevo Laredo" },
      { nombre: "Susannah Gisell Rangel Guerrero", oisa: "Puerto Vallarta" },
      { nombre: "Marilú Mass Sánchez", oisa: "Tijuana" },

      { nombre: "Leady Jazmín Hernández Pozos", oisa: "Veracruz" },
      { nombre: "José Antúnez Reyes", oisa: "Veracruz" },
      { nombre: "Sinaí Pérez Colorado", oisa: "Veracruz" },
      { nombre: "Luis Gerardo Sánchez Sosa", oisa: "Veracruz" },
      { nombre: "Rufino Domínguez Rincón", oisa: "Veracruz" },
      { nombre: "Josefina Santiz Sánchez", oisa: "Veracruz" },
      { nombre: "Ana Lilia Medina Morales", oisa: "Veracruz" },
      { nombre: "Diego Aurelio Díaz Ramírez", oisa: "Veracruz" }
    ];

    // ==========================
    // 5) AGRUPAR POR OISA
    // ==========================
    const agrupado = {};
    personal.forEach(p => {
      if (!agrupado[p.oisa]) agrupado[p.oisa] = [];
      agrupado[p.oisa].push(p.nombre);
    });

    // ==========================
    // 6) CREAR MARCADORES (guardarlos para filtrar)
    // ==========================
    const markers = []; // { oisaNombre, estado, tipo, marker }
    const bounds = [];

    Object.keys(agrupado).forEach(oisaNombre => {
      const meta = oisas[oisaNombre];
      if (!meta) return;

      const nombres = agrupado[oisaNombre].slice().sort((a,b) => a.localeCompare(b));
      const total = nombres.length;

      const popupHtml = `
        <div style="min-width:260px;">
          <div style="font-size:14px;"><strong>OISA:</strong> ${oisaNombre}</div>
          <div><strong>Estado:</strong> ${meta.estado}</div>
          <div><strong>Tipo:</strong> ${meta.tipo}</div>
          <div><strong>Total de personal:</strong> ${total}</div>
          <hr style="border:none;border-top:1px solid #eee;margin:8px 0;">
          <div style="max-height:170px; overflow:auto;">
            <strong>Listado:</strong>
            <ol style="margin:6px 0 0 18px; padding:0;">
              ${nombres.map(n => `<li>${n}</li>`).join("")}
            </ol>
          </div>
        </div>
      `;

      const m = L.circleMarker([meta.lat, meta.lng], {
        radius: 8,
        color: colorPorTipo(meta.tipo),
        fillColor: colorPorTipo(meta.tipo),
        fillOpacity: 0.85,
        weight: 2
      }).addTo(map);

      m.bindPopup(popupHtml);
      m.bindTooltip(`${oisaNombre} (${total})`, { direction: "top", offset: [0, -6] });

      markers.push({ oisaNombre, estado: meta.estado, tipo: meta.tipo, marker: m });
      bounds.push([meta.lat, meta.lng]);
    });

    if (bounds.length) map.fitBounds(bounds, { padding: [20, 20] });

    // ==========================
    // 7) LEYENDA (toma colores desde COLORS)
    // ==========================
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <div style="margin-bottom:6px;"><strong>Leyenda</strong></div>
        <div><span class="dot" style="background:${COLORS.Aeropuerto}"></span>Aeropuerto</div>
        <div><span class="dot" style="background:${COLORS.Puerto}"></span>Puerto</div>
        <div><span class="dot" style="background:${COLORS.Frontera}"></span>Frontera</div>
      `;
      return div;
    };
    legend.addTo(map);

    // ==========================
    // 8) CONTROLES DE FILTRO
    // ==========================
    const fAeropuerto = document.getElementById("fAeropuerto");
    const fPuerto     = document.getElementById("fPuerto");
    const fFrontera   = document.getElementById("fFrontera");
    const estadoSelect = document.getElementById("estadoSelect");
    const visibleCount = document.getElementById("visibleCount");
    const btnReset = document.getElementById("btnReset");

    // Poblar dropdown de estados
    const estadosUnicos = Array.from(new Set(markers.map(x => x.estado))).sort((a,b) => a.localeCompare(b));
    estadosUnicos.forEach(e => {
      const opt = document.createElement("option");
      opt.value = e;
      opt.textContent = e;
      estadoSelect.appendChild(opt);
    });

    function tipoHabilitado(tipo) {
      if (tipo === "Aeropuerto") return fAeropuerto.checked;
      if (tipo === "Puerto") return fPuerto.checked;
      if (tipo === "Frontera") return fFrontera.checked;
      return true;
    }

    function aplicarFiltros() {
      const estado = estadoSelect.value;

      let visibles = 0;
      markers.forEach(x => {
        const okTipo = tipoHabilitado(x.tipo);
        const okEstado = (estado === "__ALL__") ? true : (x.estado === estado);

        const mostrar = okTipo && okEstado;

        if (mostrar) {
          if (!map.hasLayer(x.marker)) x.marker.addTo(map);
          visibles += 1;
        } else {
          if (map.hasLayer(x.marker)) map.removeLayer(x.marker);
        }
      });

      visibleCount.textContent = `OISAs visibles: ${visibles}`;
    }

    // Eventos
    [fAeropuerto, fPuerto, fFrontera].forEach(el => el.addEventListener("change", aplicarFiltros));
    estadoSelect.addEventListener("change", aplicarFiltros);

    btnReset.addEventListener("click", () => {
      fAeropuerto.checked = true;
      fPuerto.checked = true;
      fFrontera.checked = true;
      estadoSelect.value = "__ALL__";
      aplicarFiltros();
    });

    // Aplicar al cargar
    aplicarFiltros();

    // Evitar que el scroll/drag del mapa se “pelee” con clicks del panel
    L.DomEvent.disableClickPropagation(document.getElementById("controls"));
  </script>
</body>
</html>
