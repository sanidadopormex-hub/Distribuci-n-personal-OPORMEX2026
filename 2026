<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapa de distribución del personal OPORMEX</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --banner:#2f4154;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --bg:#ffffff;
    }

    * { box-sizing: border-box; }
    body { margin:0; font-family: Arial, sans-serif; color: var(--text); background: var(--bg); }

    /* Banner estilo “segunda captura” */
    .banner{
      background: var(--banner);
      color:#fff;
      padding: 26px 16px 18px;
      text-align:center;
    }
    .banner h1{
      margin:0;
      font-size: 30px;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .banner p{
      margin: 10px 0 0;
      font-size: 14px;
      opacity: .9;
    }

    /* Layout principal */
    .app{
      display:flex;
      height: calc(100vh - 98px); /* banner aprox */
      min-height: 520px;
    }

    /* Sidebar */
    #sidebar{
      width: 330px;
      min-width: 280px;
      border-right: 1px solid var(--border);
      background:#fff;
      padding: 14px 14px 16px;
      overflow-y:auto;
    }

    .side-title{
      font-size: 16px;
      font-weight: 700;
      margin: 0 0 10px;
    }

    .hr{
      height:1px;
      background: var(--border);
      margin: 10px 0 12px;
      border:0;
    }

    .muted { color: var(--muted); font-size: 12px; }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 10px 0;
    }
    .row label{
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      font-size: 14px;
    }
    .row select, .row button{
      width:100%;
      padding: 8px 10px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#fff;
      font-size: 13px;
    }
    .row button{
      cursor:pointer;
      font-weight: 600;
    }

    /* Área del mapa */
    #mapWrap{
      flex:1;
      position:relative;
      background:#f8fafc;
    }
    #map{
      width:100%;
      height:100%;
    }

    /* Mini barra superior dentro del mapa (chips tipo captura 1) */
    .mapTopBar{
      position:absolute;
      top: 12px;
      left: 12px;
      z-index: 500;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      pointer-events:none; /* evita bloquear el mapa */
    }
    .pill{
      pointer-events:none;
      background: rgba(255,255,255,0.95);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      box-shadow: 0 1px 10px rgba(0,0,0,0.06);
    }

    /* Leyenda Leaflet */
    .legend {
      background: rgba(255,255,255,0.95);
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      line-height: 1.4;
      font-size: 13px;
      box-shadow: 0 1px 10px rgba(0,0,0,0.06);
    }
    .dot {
      display:inline-block;
      width:10px; height:10px;
      border-radius:50%;
      margin-right:8px;
      border: 1px solid #3333;
      vertical-align: middle;
    }

    /* Nota: en Google Sites, asegúrate de dar suficiente altura al iframe */
  </style>
</head>

<body>
  <div class="banner">
    <h1>Mapa Interactivo de Distribución de Personal</h1>
    <p>Selecciona filtros para visualizar las ubicaciones por OISA</p>
  </div>

  <div class="app">
    <!-- Sidebar real (NO encima del mapa) -->
    <aside id="sidebar">
      <div class="side-title">Filtrar por Tipo de Oficina</div>

      <div class="row">
        <label><input type="checkbox" id="fAeropuerto" checked> Aeropuerto</label>
      </div>
      <div class="row">
        <label><input type="checkbox" id="fPuerto" checked> Puerto</label>
      </div>
      <div class="row">
        <label><input type="checkbox" id="fFrontera" checked> Frontera</label>
      </div>

      <hr class="hr"/>

      <div class="side-title" style="margin-top:0;">Filtrar por Estado</div>
      <div class="row" style="margin-top:8px;">
        <select id="estadoSelect">
          <option value="__ALL__">Todos</option>
        </select>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="btnReset">Restablecer filtros</button>
      </div>

      <div class="muted" style="margin-top:12px;">
        Los filtros aplican por OISA (un marcador por oficina).<br/>
        En Google Sites, ajusta el alto del embed para ver todo correctamente.
      </div>
    </aside>

    <!-- Mapa -->
    <section id="mapWrap">
      <div class="mapTopBar">
        <div class="pill"><strong>Mapa de distribución del personal OPORMEX</strong></div>
        <div class="pill">Agrupado por OISA</div>
        <div class="pill" id="visibleCount">OISAs visibles: —</div>
      </div>
      <div id="map"></div>
    </section>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ==========================
    // COLORES (los tuyos)
    // ==========================
    const COLORS = {
      Aeropuerto: "#91CBF3",
      Puerto:     "#B1F68E",
      Frontera:   "#F9BD8B",
      Default:    "#cbcbcb"
    };
    function colorPorTipo(tipo){ return COLORS[tipo] || COLORS.Default; }

    // ==========================
    // MAPA BASE
    // ==========================
    const map = L.map("map").setView([23.6345, -102.5528], 5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ==========================
    // OISAs + coordenadas
    // ==========================
    const oisas = {
      "AICM": { estado: "CDMX", tipo: "Aeropuerto", lat: 19.43510, lng: -99.07130 },
      "AIFA": { estado: "Estado de México", tipo: "Aeropuerto", lat: 19.7418265, lng: -99.0132425 },
      "Cancún": { estado: "Quintana Roo", tipo: "Aeropuerto", lat: 21.0353, lng: -86.8728 },
      "Cd. Hidalgo": { estado: "Chiapas", tipo: "Frontera", lat: 14.6796279, lng: -92.1525959 },
      "Guadalajara": { estado: "Jalisco", tipo: "Aeropuerto", lat: 20.521836, lng: -103.311144 },
      "Manzanillo": { estado: "Colima", tipo: "Puerto", lat: 19.067583, lng: -104.291383 },
      "Mérida": { estado: "Yucatán", tipo: "Aeropuerto", lat: 20.937022, lng: -89.657694 },
      "Monterrey": { estado: "Nuevo León", tipo: "Aeropuerto", lat: 25.774851, lng: -100.113861 },
      "Nuevo Laredo": { estado: "Tamaulipas", tipo: "Frontera", lat: 27.47629, lng: -99.51639 },
      "Puerto Vallarta": { estado: "Jalisco", tipo: "Aeropuerto", lat: 20.68, lng: -105.25 },
      "Tijuana": { estado: "Baja California", tipo: "Frontera", lat: 32.5027, lng: -117.00371 },
      "Veracruz": { estado: "Veracruz", tipo: "Puerto", lat: 19.2, lng: -96.1333333 }
    };

    // ==========================
    // PERSONAL (tu tabla)
    // ==========================
    const personal = [
      { nombre: "Samuel Marquez Bautista", oisa: "AICM" },
      { nombre: "Alan Ernesto Orozco Guevara", oisa: "AICM" },
      { nombre: "Rominna Alexandra Díaz Olvera", oisa: "AIFA" },
      { nombre: "Leonardo Mundo Estrada", oisa: "Cancún" },
      { nombre: "Venancio Villalobos Aguilar", oisa: "Cd. Hidalgo" },
      { nombre: "Ana Karen Flores Duarte", oisa: "Guadalajara" },

      { nombre: "Mariana Alcalá Carrillo", oisa: "Manzanillo" },
      { nombre: "Marjurith Jodany Quiñonez González", oisa: "Manzanillo" },
      { nombre: "Laura Ruiz Martínez", oisa: "Manzanillo" },
      { nombre: "Julio César Flores Sánchez", oisa: "Manzanillo" },
      { nombre: "Mariana Romero Hernández", oisa: "Manzanillo" },
      { nombre: "Jaquelin Cruz Solis", oisa: "Manzanillo" },
      { nombre: "Diana Yessica Montero Delgadillo", oisa: "Manzanillo" },
      { nombre: "Melvin Jonatan Michel Ortíz", oisa: "Manzanillo" },
      { nombre: "Immer Hernández De la O", oisa: "Manzanillo" },
      { nombre: "Montserrat Soledad Rodríguez Saavedra", oisa: "Manzanillo" },
      { nombre: "Sebastián Benjamín Gallardo Castro", oisa: "Manzanillo" },
      { nombre: "Jesús Petronilo García González", oisa: "Manzanillo" },
      { nombre: "Carlos Andrés Granados Ventura", oisa: "Manzanillo" },
      { nombre: "Brenda Karina Valle Rodríguez", oisa: "Manzanillo" },
      { nombre: "Miguel Ángel Chávez González", oisa: "Manzanillo" },
      { nombre: "Liliana Carolina Moreno Rodríguez", oisa: "Manzanillo" },
      { nombre: "Grimaldo Arturo Aguilar Ríos", oisa: "Manzanillo" },
      { nombre: "Ingrid Virginia Castillo Zacarías", oisa: "Manzanillo" },
      { nombre: "Ivanna Jocelyn Martínez Reyes", oisa: "Manzanillo" },
      { nombre: "Mayra Rodríguez Olmos", oisa: "Manzanillo" },
      { nombre: "Arianna Melisa Gutiérrez Gutiérrez", oisa: "Manzanillo" },
      { nombre: "Luis Enrique García Merino", oisa: "Manzanillo" },

      { nombre: "Adrián Izabal Ceja", oisa: "Mérida" },
      { nombre: "Mario Alberto Velasco Ramírez", oisa: "Monterrey" },
      { nombre: "Albacihuatzin Portilla Naranjo", oisa: "Nuevo Laredo" },
      { nombre: "Susannah Gisell Rangel Guerrero", oisa: "Puerto Vallarta" },
      { nombre: "Marilú Mass Sánchez", oisa: "Tijuana" },

      { nombre: "Leady Jazmín Hernández Pozos", oisa: "Veracruz" },
      { nombre: "José Antúnez Reyes", oisa: "Veracruz" },
      { nombre: "Sinaí Pérez Colorado", oisa: "Veracruz" },
      { nombre: "Luis Gerardo Sánchez Sosa", oisa: "Veracruz" },
      { nombre: "Rufino Domínguez Rincón", oisa: "Veracruz" },
      { nombre: "Josefina Santiz Sánchez", oisa: "Veracruz" },
      { nombre: "Ana Lilia Medina Morales", oisa: "Veracruz" },
      { nombre: "Diego Aurelio Díaz Ramírez", oisa: "Veracruz" }
    ];

    // ==========================
    // AGRUPAR por OISA
    // ==========================
    const agrupado = {};
    personal.forEach(p => {
      if (!agrupado[p.oisa]) agrupado[p.oisa] = [];
      agrupado[p.oisa].push(p.nombre);
    });

    // ==========================
    // Crear marcadores (guardados para filtros)
    // ==========================
    const markers = []; // { oisaNombre, estado, tipo, marker }
    const bounds = [];

    Object.keys(agrupado).forEach(oisaNombre => {
      const meta = oisas[oisaNombre];
      if (!meta) return;

      const nombres = agrupado[oisaNombre].slice().sort((a,b) => a.localeCompare(b));
      const total = nombres.length;

      const popupHtml = `
        <div style="min-width:260px;">
          <div style="font-size:14px;"><strong>OISA:</strong> ${oisaNombre}</div>
          <div><strong>Estado:</strong> ${meta.estado}</div>
          <div><strong>Tipo:</strong> ${meta.tipo}</div>
          <div><strong>Total de personal:</strong> ${total}</div>
          <hr style="border:none;border-top:1px solid #eee;margin:8px 0;">
          <div style="max-height:170px; overflow:auto;">
            <strong>Listado:</strong>
            <ol style="margin:6px 0 0 18px; padding:0;">
              ${nombres.map(n => `<li>${n}</li>`).join("")}
            </ol>
