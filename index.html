<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Personal OPORMEX 2026</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    *{ box-sizing:border-box; }
    html, body{ height:100%; margin:0; font-family: Arial, sans-serif; }

    :root{
      --banner:#2f4154;
      --border:#e5e7eb;
      --muted:#6b7280;
      --bg:#f8fafc;
    }

    .banner{
      background: var(--banner);
      color:#fff;
      text-align:center;
      padding: 26px 16px 18px;
    }
    .banner h1{ margin:0; font-size:28px; font-weight:700; }
    .banner p{ margin:8px 0 0; font-size:14px; opacity:.9; }

    .app{
      display:flex;
      height: 860px;         /* ajusta esto si quieres más alto */
      min-height: 720px;
    }

    #sidebar{
      width: 360px;
      min-width: 300px;
      border-right: 1px solid var(--border);
      padding: 14px 14px 18px;
      overflow-y:auto;
      background:#fff;
    }

    #sidebar h3{ margin: 10px 0 10px; font-size:15px; }
    hr{ border:none; border-top:1px solid var(--border); margin:12px 0; }
    .muted{ font-size:12px; color: var(--muted); line-height:1.25; }

    .row{ margin:8px 0; }
    .row label{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:14px;
      cursor:pointer;
      user-select:none;
    }
    select, button, input[type="text"]{
      width:100%;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:8px;
      background:#fff;
      font-size:13px;
      outline:none;
    }
    button{ cursor:pointer; font-weight:600; }

    #mapWrap{
      flex:1;
      position:relative;
      background:var(--bg);
    }
    #map{
      width:100%;
      height:100%;
      min-height:720px;
    }

    .mapTopBar{
      position:absolute;
      top:12px;
      left:12px;
      z-index:500;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      pointer-events:none;
    }
    .pill{
      background:rgba(255,255,255,.95);
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      box-shadow:0 1px 8px rgba(0,0,0,.08);
    }

    #diag{
      position:absolute;
      top:12px;
      right:12px;
      z-index:999;
      background:rgba(0,0,0,.75);
      color:#fff;
      padding:8px 10px;
      border-radius:10px;
      font-size:12px;
      max-width: 520px;
    }

    .legend{
      background:rgba(255,255,255,.95);
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:13px;
      box-shadow:0 1px 8px rgba(0,0,0,.08);
      line-height:1.25;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      display:inline-block; margin-right:8px;
      border:1px solid #3333;
      vertical-align:middle;
    }
    .swatch{
      width:14px; height:10px; display:inline-block;
      margin-right:8px; border:1px solid #0002; border-radius:2px;
      vertical-align:middle;
    }

    /* SUBIR CONTROLES/LEYENDAS (evita que queden “hasta abajo”) */
    .leaflet-bottom.leaflet-right { margin-bottom: 22px; margin-right: 12px; }
    .leaflet-bottom.leaflet-left  { margin-bottom: 22px; margin-left: 12px; }
    .leaflet-control { margin: 12px !important; } /* control spacing general */

    /* Sección OISAs */
    .sectionTitle{
      font-weight:700; font-size:14px; margin: 8px 0 6px;
    }
    .oisaSearch{ margin-top:6px; }
    .oisaHint{ margin-top:6px; }

    .oisaCard{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 10px;
      margin:10px 0;
      background:#fff;
    }
    .oisaHead{
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .oisaHead input{ margin-top:3px; }
    .oisaMeta{
      flex:1;
      min-width:0;
    }
    .oisaName{
      font-weight:800;
      font-size:13px;
      letter-spacing:.2px;
    }
    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid var(--border);
      background:#f8fafc;
      margin-left:6px;
      white-space:nowrap;
    }
    .oisaSub{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
    }
    .people{
      margin-top:8px;
      padding-top:8px;
      border-top:1px dashed var(--border);
      font-size:12px;
    }
    .person{
      margin:6px 0;
      line-height:1.25;
    }
    .person strong{ font-size:12px; }
    .person .mini{ color:var(--muted); font-size:11px; }

  </style>
</head>

<body>

<div class="banner">
  <h1>Personal OPORMEX</h1>
  <p>2026</p>
</div>

<div class="app">

  <aside id="sidebar">
    <div class="sectionTitle">Filtros</div>

    <h3>Filtrar por Tipo de Oficina</h3>
    <div class="row"><label><input type="checkbox" id="fAeropuerto" checked> Aeropuerto</label></div>
    <div class="row"><label><input type="checkbox" id="fPuerto" checked> Puerto</label></div>
    <div class="row"><label><input type="checkbox" id="fFrontera" checked> Frontera</label></div>

    <hr>

    <h3>Filtrar por Estado</h3>
    <div class="row">
      <select id="estadoSelect">
        <option value="__ALL__">Todos</option>
      </select>
    </div>

    <div class="row">
      <label style="gap:10px;">
        <input type="checkbox" id="shadeStates" checked>
        Colorear estados (por # de personas)
      </label>
    </div>

    <div class="row">
      <button id="btnReset">Restablecer filtros</button>
    </div>

    <p class="muted">
      Los filtros aplican por OISA (un marcador por oficina).<br>
      En Google Sites, ajusta la altura del embed para evitar barras internas.
    </p>

    <hr>

    <div class="sectionTitle">OISAs y Personal</div>
    <input class="oisaSearch" type="text" id="searchBox" placeholder="Buscar OISA / Estado / Nombre..." />
    <p class="muted oisaHint">
      Marca/desmarca una OISA para mostrar/ocultar su ubicación.
      El detalle del personal se muestra aquí.
    </p>

    <div id="oisaList"></div>
  </aside>

  <section id="mapWrap">
    <div class="mapTopBar">
      <div class="pill"><strong>Distribución del personal OPORMEX</strong></div>
      <div class="pill">Agrupado por OISA</div>
      <div class="pill" id="visibleCount">OISAs visibles: —</div>
    </div>

    <div id="diag">Diagnóstico: iniciando…</div>
    <div id="map"></div>
  </section>

</div>

<!-- Leaflet JS -->
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
(function(){
  var diag = document.getElementById("diag");

  // Si Leaflet no carga (bloqueo/extensión), se verá aquí:
  if (typeof L === "undefined") {
    diag.textContent = "Diagnóstico: Leaflet NO cargó (bloqueo de red o extensión).";
    throw new Error("Leaflet no cargó");
  }

  // ====== COLORES POR TIPO (tus valores actuales) ======
  var COLORS = {
    Aeropuerto: "#98D80A",
    Puerto:     "#0A9FC2",
    Frontera:   "#FA8F00",
    Default:    "#cbcbcb"
  };
  function colorPorTipo(tipo){ return COLORS[tipo] || COLORS.Default; }

  // ====== GeoJSON de estados (RAW, para evitar 404) ======
  // Nota: Usamos un GeoJSON consolidado de estados de México (FeatureCollection).
  // Si en el futuro prefieres usar uno propio, sube el archivo al repo y cambia a: "./states.geojson"
  var STATES_GEOJSON_URL =
    "https://raw.githubusercontent.com/strotgen/mexico-leaflet/master/states.geojson";

  // ====== DATA: OISAs (coordenadas) ======
  var oisas = {
    "AICM": { estado:"CDMX", tipo:"Aeropuerto", lat:19.4351, lng:-99.0713 },
    "AIFA": { estado:"Estado de México", tipo:"Aeropuerto", lat:19.7418, lng:-99.0132 },
    "Toluca": { estado:"Estado de México", tipo:"Aeropuerto", lat:19.33694, lng:-99.56583 },

    "Cancún": { estado:"Quintana Roo", tipo:"Aeropuerto", lat:21.0353, lng:-86.8728 },
    "Cozumel": { estado:"Quintana Roo", tipo:"Puerto", lat:20.51500, lng:-86.92889 },

    "Guadalajara": { estado:"Jalisco", tipo:"Aeropuerto", lat:20.5218, lng:-103.3111 },
    "Puerto Vallarta": { estado:"Jalisco", tipo:"Aeropuerto", lat:20.68, lng:-105.25 },

    "Manzanillo": { estado:"Colima", tipo:"Puerto", lat:19.0676, lng:-104.2914 },
    "Veracruz": { estado:"Veracruz", tipo:"Puerto", lat:19.2, lng:-96.1333 },

    "Nuevo Laredo": { estado:"Tamaulipas", tipo:"Frontera", lat:27.4763, lng:-99.5164 },
    "Cd. Hidalgo": { estado:"Chiapas", tipo:"Frontera", lat:14.6796, lng:-92.1526 },
    "Tijuana": { estado:"Baja California", tipo:"Frontera", lat:32.5027, lng:-117.0037 },

    "Monterrey": { estado:"Nuevo León", tipo:"Aeropuerto", lat:25.7749, lng:-100.1139 },
    "Mérida": { estado:"Yucatán", tipo:"Aeropuerto", lat:20.9370, lng:-89.6577 }
  };

  // ====== DATA: Personal (PROF + nombre + actividad) ======
  var personal = [
    { prof:"BIÓL",  nombre:"Samuel Marquez Bautista",          oisa:"AICM",            estado:"CDMX",            tipo:"Aeropuerto", actividad:"Manejador Canino - TEA" },
    { prof:"MVZ",   nombre:"Alan Ernesto Orozco Guevara",      oisa:"AICM",            estado:"CDMX",            tipo:"Aeropuerto", actividad:"Manejador Canino - TEA" },

    { prof:"MVZ",   nombre:"Rominna Alexandra Díaz Olvera",    oisa:"AIFA",            estado:"Estado de México",tipo:"Aeropuerto", actividad:"Manejador Canino - TEA" },
    { prof:"",      nombre:"Por definir",                      oisa:"Toluca",          estado:"Estado de México",tipo:"Aeropuerto", actividad:"Por definir" },
    { prof:"",      nombre:"Por definir",                      oisa:"Toluca",          estado:"Estado de México",tipo:"Aeropuerto", actividad:"Por definir" },

    { prof:"BIÓL",  nombre:"Leonardo Mundo Estrada",           oisa:"Cancún",          estado:"Quintana Roo",    tipo:"Aeropuerto", actividad:"Manejador Canino - TEA" },
    { prof:"",      nombre:"Por definir",                      oisa:"Cozumel",         estado:"Quintana Roo",    tipo:"Puerto",     actividad:"Por definir" },

    { prof:"MVZ",   nombre:"Venancio Villalobos Aguilar",      oisa:"Cd. Hidalgo",     estado:"Chiapas",         tipo:"Frontera",   actividad:"Manejador Canino - TEA" },

    { prof:"BIÓL",  nombre:"Ana Karen Flores Duarte",          oisa:"Guadalajara",     estado:"Jalisco",         tipo:"Aeropuerto", actividad:"Manejador Canino - TEA" },

    { prof:"ING",   nombre:"Mariana Alcalá Carrillo",          oisa:"Manzanillo",      estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"ING",   nombre:"Marjurith Jodany Quiñonez González",oisa:"Manzanillo",     estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"BIÓL",  nombre:"Laura Ruiz Martínez",              oisa:"Manzanillo",      estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"MVZ",   nombre:"Julio César Flores Sánchez",       oisa:"Manzanillo",      estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"BIÓL",  nombre:"Mariana Romero Hernández",         oisa:"Manzanillo",      estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"ING",   nombre:"Jaquelin Cruz Solis",              oisa:"Manzanillo",      estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"HBIÓL.",nombre:"Diana Yessica Montero Delgadillo", oisa:"Manzanillo",      estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"QFB",   nombre:"Melvin Jonatan Michel Ortíz",      oisa:"Manzanillo",      estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"MVZ",   nombre:"Immer Hernández De la O",          oisa:"Manzanillo",      estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"ING",   nombre:"Montserrat Soledad Rodríguez Saavedra",oisa:"Manzanillo", estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"ING",   nombre:"Sebastián Benjamín Gallardo Castro",oisa:"Manzanillo",     estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"ING",   nombre:"Jesús Petronilo García González",  oisa:"Manzanillo",      estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"MVZ",   nombre:"Carlos Andrés Granados Ventura",   oisa:"Manzanillo",      estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"BIÓL",  nombre:"Brenda Karina Valle Rodríguez",    oisa:"Manzanillo",      estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"MVZ",   nombre:"Miguel Ángel Chávez González",     oisa:"Manzanillo",      estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"MVZ",   nombre:"Liliana Carolina Moreno Rodríguez",oisa:"Manzanillo",      estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"ING",   nombre:"Grimaldo Arturo Aguilar Ríos",     oisa:"Manzanillo",      estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"MVZ",   nombre:"Ingrid Virginia Castillo Zacarías",oisa:"Manzanillo",      estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"MVZ",   nombre:"Ivanna Jocelyn Martínez Reyes",    oisa:"Manzanillo",      estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"ING",   nombre:"Mayra Rodríguez Olmos",            oisa:"Manzanillo",      estado:"Colima",          tipo:"Puerto",     actividad:"TEA" },
    { prof:"MVZ",   nombre:"Arianna Melisa Gutiérrez Gutiérrez",oisa:"Manzanillo",     estado:"Colima",          tipo:"Puerto",     actividad:"En capacitación para TEA" },
    { prof:"ING",   nombre:"Luis Enrique García Merino",       oisa:"Manzanillo",      estado:"Colima",          tipo:"Puerto",     actividad:"En capacitación para TEA" },

    { prof:"BIÓL",  nombre:"Adrián Izabal Ceja",               oisa:"Mérida",          estado:"Yucatán",         tipo:"Aeropuerto", actividad:"Manejador Canino - TEA" },
    { prof:"MVZ",   nombre:"Mario Alberto Velasco Ramírez",    oisa:"Monterrey",       estado:"Nuevo León",      tipo:"Aeropuerto", actividad:"Manejador Canino - TEA" },

    { prof:"MVZ",   nombre:"Albacihuatzin Portilla Naranjo",   oisa:"Nuevo Laredo",    estado:"Tamaulipas",      tipo:"Frontera",   actividad:"En capacitación para TEA" },
    { prof:"MVZ",   nombre:"Susannah Gisell Rangel Guerrero",  oisa:"Puerto Vallarta", estado:"Jalisco",         tipo:"Aeropuerto", actividad:"Manejador Canino - TEA" },

    { prof:"BIÓL",  nombre:"Marilú Mass Sánchez",              oisa:"Tijuana",         estado:"Baja California", tipo:"Frontera",   actividad:"Manejador Canino - TEA" },

    { prof:"ING",   nombre:"Leady Jazmín Hernández Pozos",      oisa:"Veracruz",        estado:"Veracruz",        tipo:"Puerto",     actividad:"TEA" },
    { prof:"BIÓL",  nombre:"José Antúnez Reyes",               oisa:"Veracruz",        estado:"Veracruz",        tipo:"Puerto",     actividad:"TEA" },
    { prof:"MVZ",   nombre:"Sinaí Pérez Colorado",             oisa:"Veracruz",        estado:"Veracruz",        tipo:"Puerto",     actividad:"TEA" },
    { prof:"MVZ",   nombre:"Luis Gerardo Sánchez Sosa",        oisa:"Veracruz",        estado:"Veracruz",        tipo:"Puerto",     actividad:"TEA" },
    { prof:"MVZ",   nombre:"Rufino Domínguez Rincón",          oisa:"Veracruz",        estado:"Veracruz",        tipo:"Puerto",     actividad:"TEA" },
    { prof:"ING",   nombre:"Josefina Santiz Sánchez",          oisa:"Veracruz",        estado:"Veracruz",        tipo:"Puerto",     actividad:"TEA" },
    { prof:"ING",   nombre:"Ana Lilia Medina Morales",         oisa:"Veracruz",        estado:"Veracruz",        tipo:"Puerto",     actividad:"TEA" },
    { prof:"MVZ",   nombre:"Diego Aurelio Díaz Ramírez",       oisa:"Veracruz",        estado:"Veracruz",        tipo:"Puerto",     actividad:"TEA" }
  ];

  // ====== Helpers ======
  function normalize(s){
    return (s || "")
      .toString()
      .trim()
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ");
  }

  // Agrupar personal por OISA y por Estado (para choropleth)
  var peopleByOisa = {};
  var countByState = {};
  personal.forEach(function(p){
    if(!peopleByOisa[p.oisa]) peopleByOisa[p.oisa] = [];
    peopleByOisa[p.oisa].push(p);

    var st = p.estado || "";
    var k = normalize(st);
    countByState[k] = (countByState[k] || 0) + 1;
  });

  // ====== Mapa ======
  diag.textContent = "Diagnóstico: Leaflet cargado. Inicializando mapa…";

  var map = L.map("map").setView([23.6345, -102.5528], 5);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  // Asegura que Leaflet “recalcule” tamaño (clave para embeds)
  setTimeout(function(){ map.invalidateSize(true); }, 350);
  window.addEventListener("resize", function(){ map.invalidateSize(true); });

  // ====== Marcadores por OISA ======
  var markerIndex = {};       // oisa -> marker
  var markerMeta  = {};       // oisa -> {estado,tipo}
  var markersList = [];       // para filtros (estado, tipo)

  var bounds = [];
  Object.keys(oisas).forEach(function(oisaName){
    var meta = oisas[oisaName];
    markerMeta[oisaName] = meta;

    var lista = peopleByOisa[oisaName] || [];
    var total = lista.length;

    var m = L.circleMarker([meta.lat, meta.lng],{
      radius: 8,
      color: colorPorTipo(meta.tipo),
      fillColor: colorPorTipo(meta.tipo),
      fillOpacity:.85,
      weight: 2
    }).addTo(map);

    m.bindPopup(
      "<strong>OISA:</strong> "+oisaName+
      "<br><strong>Estado:</strong> "+meta.estado+
      "<br><strong>Tipo:</strong> "+meta.tipo+
      "<br><strong>Total de personal:</strong> "+total
    );

    markerIndex[oisaName] = m;
    markersList.push({ oisa:oisaName, estado:meta.estado, tipo:meta.tipo, marker:m });

    bounds.push([meta.lat, meta.lng]);
  });

  if (bounds.length) map.fitBounds(bounds,{padding:[20,20]});

  // ====== UI: filtros ======
  var fAeropuerto = document.getElementById("fAeropuerto");
  var fPuerto     = document.getElementById("fPuerto");
  var fFrontera   = document.getElementById("fFrontera");
  var estadoSelect= document.getElementById("estadoSelect");
  var visibleCount= document.getElementById("visibleCount");
  var btnReset    = document.getElementById("btnReset");
  var searchBox   = document.getElementById("searchBox");
  var oisaListEl  = document.getElementById("oisaList");
  var shadeStates = document.getElementById("shadeStates");

  // Construir dropdown de estados desde metadata OISA (no desde personal)
  var estadosSet = {};
  markersList.forEach(function(x){ estadosSet[x.estado] = true; });
  Object.keys(estadosSet).sort().forEach(function(e){
    var opt = document.createElement("option");
    opt.value = e; opt.textContent = e;
    estadoSelect.appendChild(opt);
  });

  function tipoOK(t){
    return (t==="Aeropuerto" && fAeropuerto.checked) ||
           (t==="Puerto"     && fPuerto.checked)     ||
           (t==="Frontera"   && fFrontera.checked);
  }

  // ====== Sidebar: tarjetas por OISA con checkbox + personal ======
  var oisaVisibility = {}; // oisa -> boolean (checkbox)
  Object.keys(oisas).forEach(function(k){ oisaVisibility[k] = true; });

  function renderSidebar(){
    var q = normalize(searchBox.value);
    oisaListEl.innerHTML = "";

    // Ordenar por OISA
    var oisaKeys = Object.keys(oisas).sort(function(a,b){
      return a.localeCompare(b, "es");
    });

    oisaKeys.forEach(function(oisaName){
      var meta = oisas[oisaName];
      var lista = peopleByOisa[oisaName] || [];

      // Filtro por búsqueda (OISA, estado, nombre)
      if (q){
        var hay = false;
        if (normalize(oisaName).includes(q)) hay = true;
        if (normalize(meta.estado).includes(q)) hay = true;
        if (!hay){
          for (var i=0;i<lista.length;i++){
            if (normalize(lista[i].nombre).includes(q) ||
                normalize(lista[i].prof).includes(q) ||
                normalize(lista[i].actividad).includes(q)){
              hay = true; break;
            }
          }
        }
        if (!hay) return;
      }

      var card = document.createElement("div");
      card.className = "oisaCard";

      var head = document.createElement("div");
      head.className = "oisaHead";

      var cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = !!oisaVisibility[oisaName];
      cb.addEventListener("change", function(){
        oisaVisibility[oisaName] = cb.checked;
        aplicar(); // refresca mapa
      });

      var metaDiv = document.createElement("div");
      metaDiv.className = "oisaMeta";

      var name = document.createElement("div");
      name.className = "oisaName";
      name.textContent = oisaName;

      var badge = document.createElement("span");
      badge.className = "badge";
      badge.textContent = meta.tipo.toUpperCase();
      name.appendChild(badge);

      var sub = document.createElement("div");
      sub.className = "oisaSub";
      sub.innerHTML =
        "Estado: <strong>"+meta.estado+"</strong><br>"+
        "Personal: <strong>"+lista.length+"</strong>";

      metaDiv.appendChild(name);
      metaDiv.appendChild(sub);

      head.appendChild(cb);
      head.appendChild(metaDiv);
      card.appendChild(head);

      // Personal
      var people = document.createElement("div");
      people.className = "people";

      if (lista.length === 0){
        var empty = document.createElement("div");
        empty.className = "muted";
        empty.textContent = "Sin personal capturado / por definir.";
        people.appendChild(empty);
      } else {
        lista.forEach(function(p){
          var item = document.createElement("div");
          item.className = "person";
          item.innerHTML =
            "<strong>"+(p.prof ? (p.prof+" ") : "") + p.nombre + "</strong><br>" +
            "<span class='mini'>"+(p.actividad || "—")+"</span>";
          people.appendChild(item);
        });
      }

      card.appendChild(people);
      oisaListEl.appendChild(card);
    });
  }

  // ====== Aplicar filtros al mapa ======
  function aplicar(){
    var est = estadoSelect.value;
    var visibles = 0;

    markersList.forEach(function(x){
      var ok =
        tipoOK(x.tipo) &&
        (est==="__ALL__" || est===x.estado) &&
        (oisaVisibility[x.oisa] !== false);

      if (ok){
        if (!map.hasLayer(x.marker)) map.addLayer(x.marker);
        visibles++;
      } else {
        if (map.hasLayer(x.marker)) map.removeLayer(x.marker);
      }
    });

    visibleCount.textContent = "OISAs visibles: " + visibles;
  }

  [fAeropuerto,fPuerto,fFrontera,estadoSelect].forEach(function(el){
    el.addEventListener("change", function(){
      aplicar();
    });
  });

  searchBox.addEventListener("input", function(){
    renderSidebar();
  });

  btnReset.addEventListener("click", function(){
    fAeropuerto.checked = true;
    fPuerto.checked = true;
    fFrontera.checked = true;
    estadoSelect.value = "__ALL__";
    Object.keys(oisaVisibility).forEach(function(k){ oisaVisibility[k] = true; });
    renderSidebar();
    aplicar();
  });

  // ====== Leyenda (tipo de oficina) ======
  var legendTipo = L.control({position:"bottomright"});
  legendTipo.onAdd = function(){
    var div = L.DomUtil.create("div","legend");
    div.innerHTML =
      "<strong>Leyenda (Tipo de oficina)</strong><br>"+
      '<span class="dot" style="background:'+COLORS.Aeropuerto+'"></span>Aeropuerto<br>'+
      '<span class="dot" style="background:'+COLORS.Puerto+'"></span>Puerto<br>'+
      '<span class="dot" style="background:'+COLORS.Frontera+'"></span>Frontera';
    return div;
  };
  legendTipo.addTo(map);

  // ====== Choropleth de estados (por # de personas) ======
  var statesLayer = null;
  var legendStates = null;

  function getStateNameFromFeature(props){
    // Este GeoJSON suele traer "name". Dejamos fallback.
    return props && (props.name || props.NOMBRE || props.estado || props.ESTADO || "");
  }

  function rampColor(n){
    // Escala simple (claro->oscuro) basada en cantidad
    if (n >= 20) return "#0f172a";
    if (n >= 15) return "#1f2937";
    if (n >= 10) return "#334155";
    if (n >= 7)  return "#475569";
    if (n >= 4)  return "#64748b";
    if (n >= 2)  return "#94a3b8";
    if (n >= 1)  return "#cbd5e1";
    return "#f1f5f9";
  }

  function addStatesLegend(){
    if (legendStates) return;
    legendStates = L.control({position:"bottomleft"});
    legendStates.onAdd = function(){
      var div = L.DomUtil.create("div","legend");
      div.innerHTML =
        "<strong>Estados (personas)</strong><br>"+
        '<span class="swatch" style="background:'+rampColor(1)+'"></span>1<br>'+
        '<span class="swatch" style="background:'+rampColor(2)+'"></span>2–3<br>'+
        '<span class="swatch" style="background:'+rampColor(4)+'"></span>4–6<br>'+
        '<span class="swatch" style="background:'+rampColor(7)+'"></span>7–9<br>'+
        '<span class="swatch" style="background:'+rampColor(10)+'"></span>10–14<br>'+
        '<span class="swatch" style="background:'+rampColor(15)+'"></span>15–19<br>'+
        '<span class="swatch" style="background:'+rampColor(20)+'"></span>20+';
      return div;
    };
    legendStates.addTo(map);
  }

  function removeStatesLegend(){
    if (!legendStates) return;
    map.removeControl(legendStates);
    legendStates = null;
  }

  function styleState(feature){
    var name = normalize(getStateNameFromFeature(feature.properties));
    var n = countByState[name] || 0;
    return {
      weight: 1,
      opacity: 1,
      color: "#64748b",
      fillOpacity: 0.35,
      fillColor: rampColor(n)
    };
  }

  function loadStatesGeoJSON(){
    diag.textContent = "Diagnóstico: cargando GeoJSON de estados…";

    fetch(STATES_GEOJSON_URL)
      .then(function(r){
        if(!r.ok) throw new Error("No se pudo descargar GeoJSON de estados ("+r.status+")");
        return r.json();
      })
      .then(function(geo){
        if (statesLayer) {
          map.removeLayer(statesLayer);
          statesLayer = null;
        }

        statesLayer = L.geoJSON(geo, {
          style: styleState,
          onEachFeature: function(feature, layer){
  var stNameRaw = getStateNameFromFeature(feature.properties);
  var stNameKey = normalize(stNameRaw);
  var n = countByState[stNameKey] || 0;

  // Si no hay personal, no mostramos tooltip y evitamos interacción
  if (n === 0) {
    layer.options.interactive = false;
    return;
  }

  // Tooltip solo si hay personal
  layer.bindTooltip(
    stNameRaw + ": " + n,
    { sticky:true, direction:"auto" }
  );
}
        });

        if (shadeStates.checked){
          statesLayer.addTo(map);
          addStatesLegend();
        }

        diag.textContent = "Diagnóstico: GeoJSON cargado correctamente.";
        setTimeout(function(){ diag.style.display="none"; }, 2000);
      })
      .catch(function(err){
        diag.style.display = "block";
        diag.textContent = "Diagnóstico: no se pudo cargar GeoJSON de estados. " + err.message;
        // No detenemos el mapa, solo desactivamos el sombreado
        shadeStates.checked = false;
        removeStatesLegend();
      });
  }
/* ===============================
   MODO MÓVIL / RESPONSIVE
   =============================== */
@media (max-width: 900px){

  .app{
    flex-direction: column;
    height: auto;
    min-height: auto;
  }

  #sidebar{
    width: 100%;
    min-width: 100%;
    max-height: 55vh;
    border-right: none;
    border-bottom: 1px solid var(--border);
  }

  #mapWrap{
    width: 100%;
    height: 65vh;
    min-height: 420px;
  }

  #map{
    min-height: 420px;
  }

  /* Ajustar pills superiores */
  .mapTopBar{
    left: 8px;
    right: 8px;
    gap: 6px;
  }

  .pill{
    font-size: 11px;
    padding: 5px 8px;
  }

  /* Leyendas más compactas */
  .legend{
    font-size: 12px;
    padding: 8px 10px;
  }
}

  shadeStates.addEventListener("change", function(){
    if (!statesLayer){
      if (shadeStates.checked) loadStatesGeoJSON();
      return;
    }
    if (shadeStates.checked){
      statesLayer.addTo(map);
      addStatesLegend();
    } else {
      map.removeLayer(statesLayer);
      removeStatesLegend();
    }
  });

  // ====== Inicializar UI ======
  renderSidebar();
  aplicar();
  loadStatesGeoJSON();

})();
</script>

</body>
</html>
